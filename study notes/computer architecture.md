## 1. 概念
  - #### 1.1发展
    <center>
      <table>
        <tr>
          <th>时间</th>
          <th>发展</th>
          <th>速度</th>
        </tr>
        <tr>
          <th>1946之后的25年</th>
          <th>计算机制造技术发展，计算机系统结构创新</th>
          <th>提高25%</th>
        </tr>
        <tr>
          <th>20世纪70年代末和80年代初</th>
          <th>大规模集成电路，微处理器</th>
          <th>35%</th>
        </tr>
        <tr>
          <th>80年代中期后16年</th>
          <th>RISC</th>
          <th>50%</th>
        </tr>
        <tr>
          <th>2002年后</th>
          <th>功耗问题，可开发并行指令减少，存储器访问缓慢，</th>
          <th>降到20%</th>
        </tr>
        <tr>
          <th>2014年后</th>
          <th>多核处理，指令级并行转向线程级数据级并行</th>
          <th>/</th>
        </tr>
      </table>
    </center>

  - #### 1.2层次结构
   <center>翻译方法实现</center>

    ->L6：应用语言虚拟机
    ->L5：高级语言虚拟机
    ->L4:汇编语言虚拟机

   <center>解释方法实现</center>

    ->L3:操作系统虚拟机：传统机器级指令+操作系统级指令
    ->L2:机器语言(传统机器级)：RISC无L1，L2直接采用硬件逻辑，速度快
    ->L1:微程序机器级：微指令集
   低层计算机属性对高层计算机的程序员是透明的<p>
   计算机结构/组成/实现<p>
   计算机系统结构Flynn分类：SISD,SIMD,MISD,MIMD

  - #### 1.3定量分析技术
    - ##### 计算机系统设计定量原理
      - 以经常性事件为重点
      - Amdahl定律*
        <center>

          $系统加速比=\frac{系统性能_{改进后}}{系统性能_{改进前}}=\frac{总时间_{改进前}}{总时间_{改进后}}=\frac1{(1-改进比例)+\frac{改进比例}{部件加速比}}$
        </center>
      - cpu性能公式*
        <center>
        CPU时间 = IC × CPI × 时钟周期时间
        </center>
    - ##### 计算机系统性能评测
      - $n=\frac{执行时间_Y}{执行时间_X}=\frac{性能_X}{性能_Y}$ 执行时间和性能成反比
      - 基准测试程序(benchmark)
      <p/>

  - 1.4计算机结构的发展
    - 冯诺依曼结构
  - 1.5 并行 指令内部并行——>指令集并行——>线程级并行——>任务级或过程级并行——>作业或程序并行
    - 措施：时间重叠，资源重复，资源共享

## 2. 指令集结构
#### 2.1分类
  <center>
    <table>
      <tr>
        <th>堆栈结构</th>
        <th>累加器结构</th>
        <th>寄存器-存储器结构(RM)</th>
        <th>寄存器-寄存器结构(RR)</th>
      </tr>
      <tr>
        <th>操作数都为隐式，位于栈顶/次栈顶</th>
        <th>操作数累加器为隐式，存储器单元显式</th>
        <th>显式，位于寄存器/存储器</th>
        <th>显式，都位于寄存器</th>
      </tr>
      <tr>
        <th>结果写入栈顶</th>
        <th>结果送回累加器</th>
        <th>结果写入通用寄存器组</th>
        <th>结果写入通用寄存器组</th>
      </tr>
      <tr>
        <th>程序占用空间小|堆栈无法随机访问</th>
        <th>占用空间小|会频繁访问存储器</th>
        <th>访问速度快，容易编译，代码紧凑|操作数不对称，时钟周期不同</th>
        <th>访问速度快，容易编译，代码简洁，时钟周期相近|指令条数多，耗内存</th>
      </tr>
      <tr>
        <th>push A</th>
        <th>load A</th>
        <th>load R1,A</th>
        <th>load R1,A</th>
      </tr>
      <tr>
        <th>push B</th>
        <th>add B</th>
        <th>add R1,B</th>
        <th>add R2,B</th>
      </tr>
      <tr>
        <th>add</th>
        <th>store C</th>
        <th>store R1,C</th>
        <th>add R3,R1,R2</th>
      </tr>
      <tr>
        <th>pop C</th>
        <th></th>
        <th></th>
        <th>store R3,C</th>
      </tr>
    </table>
  </center>

#### 2.2寻址方式(部分)
  - 立即数寻址：Regs[R]<——Regs[R]+num<p>
  - 直接寻址：Regs[R]<——Regs[R]+Mem[num]<p>
  - 寄存器寻址：Regs[R1]<——Regs[R1]+Regs[R2]<p>
  - 寄存器间接寻址：Regs[R2]<——Regs[R2]+Mem[Regs[R1]]<p>
  - 偏移寻址：Regs[R2]<——Regs[R2]+Mem[Regs[R1]+num]<p>
  - 存储器间接寻址：Regs[R2]<——Regs[R2]+Mem[Mem[Regs[R1]]]<p>
  - 索引寻址：Regs[R3]<——Regs[R3]+Mem[Regs[R1]+Regs[R2]]<p>

#### 2.3功能设计
  - 指令级基本要求：完整性(指令足够用)，规整性(对称性，均匀性)，高效率(指令执行速度快，使用频度高)，兼容性
  - CISC
    - 面向目标程序的增强指令：增强运算型指令，数据传送指令，程序控制指令|三方面会增加硬件成本和复杂度
    - 面向高级语言的优化：增强对高级语言和编译器的支持，使高级语言成为计算机的机器语言
    - 面向操作系统的优化：指令级支持操作系统进程的管理和切换，存储管理，信息保护，进程同步与互斥
    - 存在问题：许多指令很少用|指令级庞大，条数多，指令功能复杂，占用大量芯片面积容易造成错误|CPI值较大，执行速度慢|不易采用流水线技术提升性能
  - RISC原则：指令条数少且简单|采用简单而统一的指令格式，并减少寻址方式|指令执行在单个周期内完成|采用load-host结构，除load和host可访问存储器，其他指令都在寄存器间进行|指令采用硬件逻辑实现|优化编辑器|利用流水线技术提升性能
## 3. 流水线技术

#### 3.1 概念
- 将每个子过程和部件称为流水线的级或段，把段连接起来形成了流水线；流水线的段数称为深度。
- 流水线的执行过程：取指令，译码，执行，存结果
- 流水线的执行过程采用时空图描述
- 流水线特点
  - 流水线把一个处理过程分解为若干子过程，每个子过程由专门的部件实现，过程间并行工作以缩短时间
  - 流水线各段的时间应该尽可能相等，否则会形成瓶颈
  - 流水线每个功能部件后面需要一个缓冲寄存器(锁存器)传送相邻间的数据，并隔离各段的处理工作
  - 流水线技术适合于大量重复的时序过程
  - 流水线技术需要通过时间和排空时间
- 流水线的分类
  - 单功能流水线|多功能流水线
  - 静态流水线|动态流水线
  - 部件级流水线|处理机级流水线|处理机间流水线
  - 线性流水线|非线性流水线
  - 顺序流水线|乱序流水线

#### 3.2 性能指标*
- 吞吐率：$TP = \frac{n}{T_k}$
  - 各段时间相等流水线：$TP = \frac{n}{(k+n-1)\Delta t}$<p>
    $TP_{max} = lim \frac{n}{(k+n-1)\Delta t} = \frac1{\Delta t}$ | $TP = \frac{n}{k+n-1}TP_{max}$ (当 n>>k 时 $TP \approx TP_{max}$)
  - 各段时间不相等流水线：$TP = \frac{n}{\sum_{i=1}^k \Delta t_i+(n-1)max(\Delta t_1,\Delta t_2...,\Delta t_k)}$<p>
    $TP_{max} = \frac1{max(\Delta t_1,\Delta t_2...,\Delta t_k)}$
  - 解决瓶颈问题：细分瓶颈段，使各段时间相等|重复设置瓶颈段并行工作(控制逻辑复杂，硬件成本高)
- 加速比：$S = \frac{T_s}{T_k}$
  - 各段相等：$S = \frac{nk}{k+n-1}$
  - 各段不相等：$S = \frac{n\sum_{i=1}^k \Delta t_i}{\sum_{i=1}^k \Delta t_i+(n-1)max(\Delta t_1,\Delta t_2...,\Delta t_k)}$
- 效率:$E = TP·\Delta t$ | $E = \frac{S}{k}$
  - 各段相等：$E = \frac{n}{k+n-1}$
  - 各段不相等：$E = \frac{n\sum_{i=1}^k \Delta t_i}{k[\sum_{i=1}^k \Delta t_i+(n-1)max(\Delta t_1,\Delta t_2...,\Delta t_k)]}$

#### 3.3 流水线的相关和冲突
- 五段流水线
- 流水线相关
  - 数据相关
  - 名相关
    - 反相关
    - 输出相关
    - 换名技术
  - 控制相关
- 流水线冲突
  - 结构冲突
    - 增加停顿周期(气泡)
  - 数据冲突
    - 写后读冲突
    - 写后写冲突
    - 读后写冲突
    - 定向(旁路)技术：
    - 互锁机制：
    - 指令/流水线调度技术：
  - 控制冲突
